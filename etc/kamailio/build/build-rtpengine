#!/bin/sh

sudo mkdir -d /etc/kamailio/build
sudo chown $USER /etc/kamailio/build
sudo chmod 750 /etc/kamailio/build

sudo apt-get -y update
# sudo apt -y upgrade
sudo apt-get -y install dpkg-dev

git clone https://github.com/sipwise/rtpengine

# install dependencies
sudo apt-get -y install iptables-dev 
sudo apt-get -y install libxtables-dev
sudo apt-get -y install cmake libjson-perl libwebsockets-dev
sudo apt-get -y install debhelper default-libmysqlclient-dev gperf libavcodec-dev libavfilter-dev libavformat-dev libavutil-dev libbencode-perl libcrypt-openssl-rsa-perl libcrypt-rijndael-perl libhiredis-dev libio-multiplex-perl libio-socket-inet6-perl libjson-glib-dev libdigest-crc-perl libdigest-hmac-perl libnet-interface-perl libnet-interface-perl libssl-dev libsystemd-dev libxmlrpc-core-c3-dev libcurl4-openssl-dev libevent-dev libpcap0.8-dev markdown unzip nfs-common dkms libspandsp-dev libiptc-dev libmosquitto-dev python3-websockets

# version 1 install into /etc/kamailio/build/
#VER=1.0.4
#curl https://codeload.github.com/BelledonneCommunications/bcg729/tar.gz/$VER >bcg729_$VER.orig.tar.gz
#tar zxf bcg729_$VER.orig.tar.gz 
#cd bcg729-$VER 
#git clone https://github.com/ossobv/bcg729-deb.git debian 
#dpkg-buildpackage -us -uc -sa -b -rfakeroot
#cd ../

# version 2 install into /etc/kamailio/build/
git clone https://github.com/vma/bcg729
cd bcg729
fakeroot dh binary
cd ..
sudo dpkg -i libbcg729-*.deb

cd rtpengine
# check dependencies -  should be none missing
if ! (dpkg-checkbuilddeps) ; then
    echo "Dependencies check failed!"
    # exit 1
fi
dpkg-buildpackage --no-sign
# if desperate
# dpkg-buildpackage  --no-sign -d

dpkg -i ngcp-rtpengine-daemon_*.deb ngcp-rtpengine-iptables_*.deb ngcp-rtpengine-kernel-dkms_*.deb 

# Clean up
sudo apt -y autoremove
